<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S…ôni Sevir…ôm G√ºl√ºm üåπüíó</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL_NEW = 'https://gcjazjogapzuuhxbbxnd.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjamF6am9nYXB6dXVoeGJieG5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzI4MjcsImV4cCI6MjA3NjIwODgyN30.7XBqphPnFhUie3KVMMePUzJLVkWJGgJc0O9av6qCZas'

        const supabase = createClient(SUPABASE_URL_NEW, SUPABASE_ANON_KEY)

        const input = document.getElementById('message-input')
        const btn = document.getElementById('send-btn')
        const status = document.getElementById('status')

        // client-side limit v…ô sanitasiya
        function validMessage(m) {
            if (!m) return false
            const trimmed = m.trim()
            if (trimmed.length === 0) return false
            if (trimmed.length > 1000) return false
            return trimmed
        }

        async function getPublicIP() {
            try {
                const r = await fetch('https://api.ipify.org?format=json')
                const j = await r.json()
                return j.ip || null
            } catch (e) {
                console.warn('IP alƒ±nmadƒ±:', e)
                return null
            }
        }

        // Baku vaxtƒ±nƒ± ISO +04:00 formatƒ±nda qaytarƒ±r: YYYY-MM-DDTHH:MM:SS+04:00
        function getBakuIsoWithOffset() {
            // Azerbaijan is UTC+4 (no DST)
            const offsetHours = 4
            const now = new Date()

            // compute UTC components then add offsetHours
            const year = now.getUTCFullYear()
            const month = now.getUTCMonth() + 1 // 0-11 -> 1-12
            const day = now.getUTCDate()
            const hour = now.getUTCHours()
            const minute = now.getUTCMinutes()
            const second = now.getUTCSeconds()

            // build a Date in UTC then add offset hours to get Baku local time components
            const utcMillis = Date.UTC(year, month - 1, day, hour, minute, second)
            const bakuMillis = utcMillis + offsetHours * 3600 * 1000
            const baku = new Date(bakuMillis)

            const pad = (n) => String(n).padStart(2, '0')

            const Y = baku.getUTCFullYear()
            const M = pad(baku.getUTCMonth() + 1)
            const D = pad(baku.getUTCDate())
            const H = pad(baku.getUTCHours())
            const Min = pad(baku.getUTCMinutes())
            const S = pad(baku.getUTCSeconds())

            // append explicit timezone offset +04:00
            return `${Y}-${M}-${D}T${H}:${Min}:${S}+04:00`
        }

        async function sendMessage() {
            status.textContent = ''
            const raw = input.value
            const message = validMessage(raw)
            if (!message) {
                alert('Z…ôhm…ôt olmasa qƒ±sa bir mesaj yazƒ±n (1‚Äì1000 simvol).')
                return
            }

            btn.disabled = true
            status.style.color = 'black'
            status.textContent = 'G√∂nd…ôrilir...'

            // PUBLIC IP al (bu yol public IP qaytarƒ±r; daha etibarlƒ± yol server t…ôr…ôfi il…ôdir)
            const ip = await getPublicIP()

            // Baku vaxtƒ±nƒ± hazƒ±rla
            const created_at = getBakuIsoWithOffset()

            // Supabase .insert() parametrik olduƒüu √º√ß√ºn SQL injection riski burada yoxdur
            const { data, error } = await supabase
                .from('messages')
                .insert([{ message: message, ip, created_at }])

            if (error) {
                console.error('Insert error:', error)
                status.style.color = 'red'
                status.textContent = 'X…ôta ba≈ü verdi'
            } else {
                console.log('Inserted:', data)
                status.style.color = 'green'
                status.textContent = 'G√∂nd…ôrildi ‚úî'
                input.value = ''
            }

            btn.disabled = false
            setTimeout(() => status.textContent = '', 3000)
        }

        btn.addEventListener('click', sendMessage)

        // optional: enter il…ô d…ô g√∂nd…ôrm…ôk
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage()
        })
    </script>
    <script>
        // --- √ñz layih…ô m…ôlumatlarƒ±nƒ± bura …ôlav…ô et ---
        const SUPABASE_URL = "https://gcjazjogapzuuhxbbxnd.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjamF6am9nYXB6dXVoeGJieG5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzI4MjcsImV4cCI6MjA3NjIwODgyN30.7XBqphPnFhUie3KVMMePUzJLVkWJGgJc0O9av6qCZas";

        // Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // IP-ni …ôld…ô ed…ôn funksiya
        async function getPublicIP() {
            try {
                const res = await fetch("https://api.ipify.org?format=json");
                if (!res.ok) throw new Error("IP alƒ±nmadƒ±");
                const data = await res.json();
                return data.ip;
            } catch (err) {
                console.error("IP x…ôtasƒ±:", err);
                return "unknown";
            }
        }

        // Bakƒ± vaxtƒ±nƒ± qaytaran funksiya (UTC+4)
        function getBakuTime() {
            const now = new Date();
            const utc = now.getTime() + now.getTimezoneOffset() * 60000;
            const baku = new Date(utc + 4 * 60 * 60000);
            return baku.toLocaleString("az-AZ", {
                timeZone: "Asia/Baku",
                hour12: false,
            });
        }

        // Supabase-…ô yazan funksiya
        async function logVisitor() {
            const ip = await getPublicIP();
            const visit_time = getBakuTime();

            try {
                const { error } = await supabaseClient
                    .from("visitors")
                    .insert([{ ip_address: ip, visit_time }]);

                if (error) console.error("Supabase insert error:", error);
                else console.log("Ziyar…ôt√ßi qeyd olundu:", ip, visit_time);
            } catch (err) {
                console.error("X…ôta:", err);
            }
        }

        // Sayt y√ºkl…ôn…ônd…ô yaz
        window.addEventListener("DOMContentLoaded", logVisitor);
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="script.js" defer></script>
</head>

<body>
    <audio id="bgMusic" src="audio/music.mp3" autoplay loop preload="metadata"></audio>

    <nav class="navbar">
        <h1>AYG√úL</h1>
        <div class="nav-center">
            <div class="logo-placeholder">
                <img src="img/logo.png" alt="">
            </div>
        </div>
        <h1>∆èLƒ∞</h1>
    </nav>

    <section class="home">
        <h1>S…ôni Sevir…ôm ü§ç</h1>
        <p>H…ôr g√ºn, h…ôr saniy…ô s…ôni d√º≈ü√ºn√ºr…ôm...</p>
    </section>

    <section class="message">
        <div class="msg-box">
            <div id="poemLines">
                <p>
                    S…ôn m…ônim …ôn g√∂z…ôl t…ôsad√ºf√ºms…ôn<br>
                    G√∂zl…ôrin…ô baxanda d√ºnyanƒ±n s…ôsi k…ôsilir...<br>
                    √úr…ôyim yalnƒ±z s…ônin √º√ß√ºn d√∂y√ºn√ºr<br>
                    Uzaq olsan bel…ô, d√º≈ü√ºnc…ôl…ôrimd…ô h…ômi≈ü…ô yanƒ±mdasan
                </p>
            </div>
            <span class="signature">‚Äî ∆èli ü§ç</span>
            <div class="controls">
                <button id="prevButn">‚ùÆ</button>
                <button id="nextButn">‚ùØ</button>
            </div>
        </div>
    </section>
    <section id="messagefronclient">
        <div class="message-fromclient"
            style="display: block;max-width:520px;margin:40px auto;font-family:Arial,Helvetica,sans-serif;">
            <h2 style="color: rgb(252, 95, 95);text-align:center">√úr…ôk s√∂zl…ôrini bura yaz g√ºl√ºm ü§ç</h2>
            <input id="message-input" type="text" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                style="width:100%;margin-top:10px;padding:10px;font-size:16px;border-radius: 20px" />
            <div style="margin-top:10px; display: flex; justify-content: center">
                <button id="send-btn" style="background-color:pink;padding:10px 16px;font-size:16px;border-radius: 10px">G√∂nd…ôr</button>
                <span id="status" style="margin-left:12px;color:green"></span>
            </div>
        </div>
    </section>
    <section class="carousel">
        <div class="textbox" style="margin-bottom: 10px; text-align: center">
            <h1 style="color: #d6b11a">Xatir…ôl…ôrimiz ü§ç</h1>
            <h2 style="font-size: 22px">Son Yenil…ônm…ô: 19-10-2025 01:00</h2>
        </div>
        <div class="slides">
            <img src="img/1.jpg">
            <img src="img/2.jpg">
            <img src="img/3.jpg">
            <img src="img/4.jpg">
            <img src="img/5.jpg">
            <img src="img/6.jpg">
            <img src="img/7.jpg">
            <img src="img/8.jpg">
            <img src="img/9.jpg">
            <img src="img/10.jpg">
            <img src="img/11.jpg">
            <img src="img/12.jpg">
            <img src="img/13.jpg">
            <img src="img/14.jpg">
            <img src="img/15.jpg">
            <img src="img/16.jpg">
            <img src="img/17.jpg">
            <img src="img/18.jpg">
            <img src="img/19.jpg">
            <img src="img/20.jpg">
            <img src="img/21.jpg">
            <img src="img/22.jpg">
            <img src="img/23.jpg">
            <img src="img/24.jpg">
            <img src="img/25.jpg">
            <img src="img/26.jpg">
            <img src="img/27.jpg">
            <img src="img/28.jpg">
            <img src="img/29.jpg">
            <img src="img/30.jpg">
            <img src="img/31.jpg">
            <img src="img/32.jpg">
            <img src="img/33.jpg">
            <img src="img/34.jpg">
            <img src="img/35.jpg">
            <img src="img/36.jpg">
            <img src="img/36.jpg">
            <img src="img/37.jpg">
            <img src="img/38.jpg">
            <img src="img/39.jpg">
            <img src="img/40.jpg">
            <img src="img/41.jpg">
            <img src="img/42.jpg">
            <img src="img/43.jpg">
        </div>

        <!-- ke√ßid d√ºym…ôl…ôri -->
        <button class="prev">‚ùÆ</button>
        <button class="next">‚ùØ</button>
    </section>
</body>

</html>